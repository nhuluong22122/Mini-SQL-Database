01. Setup and inserts

CREATE TABLE statement

dbfile.bin size = 192
CREATE TABLE statement

dbfile.bin size = 336
INSERT statement
tab1.tab size: 56. Number of records: 1

dbfile.bin size = 336
INSERT statement
tab1.tab size: 88. Number of records: 2

dbfile.bin size = 336
INSERT statement
tab1.tab size: 120. Number of records: 3

dbfile.bin size = 336
INSERT statement
tab2.tab size: 56. Number of records: 1

dbfile.bin size = 336
INSERT statement
tab2.tab size: 88. Number of records: 2

dbfile.bin size = 336
INSERT statement
tab2.tab size: 120. Number of records: 3

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+--------------------+
|name                |quizzes             |midterm             |final               |
+--------------------+--------------------+--------------------+--------------------+
|Siu                 |                  11|                  80|                 560|
|Frank               |                  22|                 100|                 700|
|Jordon              |                  33|                  75|                 525|
+--------------------+--------------------+--------------------+--------------------+
3 rows selected.

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+
|college             |zipcode             |rank                |
+--------------------+--------------------+--------------------+
|UCLA                |11111               |                   3|
|SJSU                |22222               |                  10|
|Stanford            |33333               |                   2|
+--------------------+--------------------+--------------------+
3 rows selected.

Check transaction log

20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"

02. Take backup, check image size and db.log

dbfile.bin size = 336
BACKUP statement

**Size** first=584; dbfile.bin=336; tab1=120 (3 rows); tab2=120 (3 rows)
-rw-r--r--  1 nhuluong  staff  336 May  9 23:57 dbfile.bin
-rw-r--r--  1 nhuluong  staff  584 May  9 23:57 first
-rw-r--r--  1 nhuluong  staff  120 May  9 23:57 tab1.tab
-rw-r--r--  1 nhuluong  staff  120 May  9 23:57 tab2.tab
20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first

03. Do more I/U/D

dbfile.bin size = 336
INSERT statement
tab1.tab size: 152. Number of records: 4

dbfile.bin size = 336
INSERT statement
tab2.tab size: 152. Number of records: 4

Wait a few seconds
Pause here, press enter to continue

dbfile.bin size = 336
INSERT statement
tab1.tab size: 184. Number of records: 5

dbfile.bin size = 336
INSERT statement
tab2.tab size: 184. Number of records: 5

dbfile.bin size = 336
DELETE statement
Delete 1 rows. 

Wait a few seconds
Pause here, press enter to continue

dbfile.bin size = 336
DELETE statement
Delete 1 rows. 

dbfile.bin size = 336
UPDATE statement
Updated 1 rows.

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+--------------------+
|name                |quizzes             |midterm             |final               |
+--------------------+--------------------+--------------------+--------------------+
|Siu                 |                  11|                  80|                 999|
|Frank               |                  22|                 100|                 700|
|Jordon              |                  33|                  75|                 525|
|Jeff                |                  44|                  60|                 515|
|Ying                |                  55|                  85|                 625|
+--------------------+--------------------+--------------------+--------------------+
5 rows selected.

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+
|college             |zipcode             |rank                |
+--------------------+--------------------+--------------------+
|USC                 |55555               |                   4|
|UC Berkley          |44444               |                   1|
|Stanford            |33333               |                   2|
+--------------------+--------------------+--------------------+
3 rows selected.

20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"

04. Take 2nd backup, check image size and db.log

dbfile.bin size = 336
BACKUP statement

**Size** first=648; dbfile.bin=336; tab1=184 (5 rows); tab2=120 (3 rows)
-rw-r--r--  1 nhuluong  staff  336 May  9 23:57 dbfile.bin
-rw-r--r--  1 nhuluong  staff  648 May  9 23:57 second
-rw-r--r--  1 nhuluong  staff  184 May  9 23:57 tab1.tab
-rw-r--r--  1 nhuluong  staff  120 May  9 23:57 tab2.tab
20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"
BACKUP second

05. drop tab2, restore from second, check tab2 and RF_START in log

dbfile.bin size = 336
DROP TABLE statement
DELETED Filename: tab2.tab

ls: tab2.tab: No such file or directory

dbfile.bin size = 192
RESTORE statement

tab2.tab
THIS SHOULD FAIL because it should be RF Pending
dbfile.bin size = 336
ROLLFORWARD In Progress | Cannot accept any commands
Error in the string: create
rc=-328

20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"
BACKUP second
RF_START
20180509235759 "drop table tab2"

06. Do rollforward, tab2 should be dropped again and RF_START is removed

dbfile.bin size = 336
ROLLFORWARD statement
dbfile.bin size = 336
DROP TABLE statement
DELETED Filename: tab2.tab

ls: tab2.tab: No such file or directory

20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"
BACKUP second
20180509235759 "drop table tab2"

07. Do restore from second without RF, check db.log1 before prune,
    check tab2 contents

dbfile.bin size = 192
CREATE TABLE statement

dbfile.bin size = 264
INSERT statement
tab3.tab size: 32. Number of records: 1

20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"
BACKUP second
20180509235759 "drop table tab2"
20180509235759 "create table tab3(c1 int)"
20180509235759 "insert into tab3 values(911)"

dbfile.bin size = 264
RESTORE statement

db.log1
tab 3 should be gone from PRUNING without rf
20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"
BACKUP second

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+
|college             |zipcode             |rank                |
+--------------------+--------------------+--------------------+
|USC                 |55555               |                   4|
|UC Berkley          |44444               |                   1|
|Stanford            |33333               |                   2|
+--------------------+--------------------+--------------------+
3 rows selected.

08. restore from fisrt, check tab1 & tab2 contents

dbfile.bin size = 336
RESTORE statement

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+--------------------+
|name                |quizzes             |midterm             |final               |
+--------------------+--------------------+--------------------+--------------------+
|Siu                 |                  11|                  80|                 560|
|Frank               |                  22|                 100|                 700|
|Jordon              |                  33|                  75|                 525|
+--------------------+--------------------+--------------------+--------------------+
3 rows selected.

dbfile.bin size = 336
SELECT statement
+--------------------+--------------------+--------------------+
|college             |zipcode             |rank                |
+--------------------+--------------------+--------------------+
|UCLA                |11111               |                   3|
|SJSU                |22222               |                  10|
|Stanford            |33333               |                   2|
+--------------------+--------------------+--------------------+
3 rows selected.

20180509235756 "create table tab1(name char(16), quizzes int, midterm int, final int)"
20180509235756 "create table tab2(college char(20), zipcode char(5), rank int)"
20180509235756 "insert into tab1 values('Siu', 11, 80, 560)"
20180509235756 "insert into tab1 values('Frank', 22, 100, 700)"
20180509235756 "insert into tab1 values('Jordon', 33, 75, 525)"
20180509235756 "insert into tab2 values('UCLA', '11111', 3)"
20180509235756 "insert into tab2 values('SJSU', '22222', 10)"
20180509235756 "insert into tab2 values('Stanford', '33333', 2)"
BACKUP first
RF_START
20180509235756 "insert into tab1 values('Jeff', 44, 60, 515)"
20180509235756 "insert into tab2 values('UC Berkley', '44444', 1)"
20180509235757 "insert into tab1 values('Ying', 55, 85, 625)"
20180509235757 "insert into tab2 values('USC', '55555', 4)"
20180509235757 "delete from tab2 where college = 'UCLA'"
20180509235759 "delete from tab2 where college = 'SJSU'"
20180509235759 "update tab1 set final = 999 where name = 'Siu'"
BACKUP second

09. Do rollforward to timestamp  -  Manual step from a different window
In this case the timestamp is between the deletion of the 1st the 2nd row from tab2 e.g. db rollforward to 20030531123030
Pause here, press enter to continue


10. Copy the db.log to db.log3, copy db.log1 to db.log, restore from second,
    rollforward, verify tab2 is dropped again.



dbfile.bin size = 336
RESTORE statement
Pause here, press enter to continue


dbfile.bin size = 336
ROLLFORWARD statement
dbfile.bin size = 336
DROP TABLE statement
DELETED Filename: tab2.tab
dbfile.bin size = 192
CREATE TABLE statement
dbfile.bin size = 264
INSERT statement
tab3.tab size: 32. Number of records: 1
ls: tab2.tab: No such file or directory

11 - 13. Errors - dupicate backup image name, bad image name, bad timestamp, wrong state

dbfile.bin size = 264
BACKUP statement

dbfile.bin size = 264
BACKUP statement
This image file already existed
Error in the string: third
rc=-387

dbfile.bin size = 264
RESTORE statement
This image file doesn't exist
Error in the string: nothing
rc=-386

dbfile.bin size = 264
INSERT statement
tab1.tab size: 216. Number of records: 6

dbfile.bin size = 264
ROLLFORWARD statement
Cannot find RF_START in log
Error in the string: 
rc=-329

dbfile.bin size = 264
RESTORE statement

dbfile.bin size = 264
ROLLFORWARD statement
20030531123030
Invalid timestamp or not found
Error in the string: 20030531123030
rc=-329

dbfile.bin size = 264
ROLLFORWARD statement
dbfile.bin size = 264
INSERT statement
tab1.tab size: 216. Number of records: 6

dbfile.bin size = 264
SELECT statement
+--------------------+--------------------+--------------------+--------------------+
|name                |quizzes             |midterm             |final               |
+--------------------+--------------------+--------------------+--------------------+
|Siu                 |                  11|                  80|                 999|
|Frank               |                  22|                 100|                 700|
|Jordon              |                  33|                  75|                 525|
|Jeff                |                  44|                  60|                 515|
|Ying                |                  55|                  85|                 625|
|new                 |                  55|                  85|                 625|
+--------------------+--------------------+--------------------+--------------------+
6 rows selected.

End of test1.bat

nhus-mbp-2:Proj1 nhuluong$ 
